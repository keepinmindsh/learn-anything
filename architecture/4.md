# 안정 해시 설계 

수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누느 것이 중요하다. 

## 해시 키 재배치(rehash) 문제 

N개의 캐시서버가 있다고 할때, 서버들이 부하ㅏ를 균등하게 나누는 보편적인 방법은 아래의 해시 함수를 사용하는 것이다. 

```
serverIndex = hash(key) % N (N은 서버의 개수)
```

만약 서버의 개수가 4대라면, 서버 0, 1, 2, 3에 각각 키를 할당할 수 있다.   
하지만 서버의 한대에 문제가 발생하여 서버가 다운되거나, 서버를 추가하거나 제거하는 경우, 해시 키를 재배치해야 한다.   

이때 해시키가 재배치가 발생하게 되고, 대부분이 캐시 클라이언트는 데이터가 없는 엉뚱한 서버에 접속하게 되는데, 이는 결국 대규모 캐시 미스로 발생할 수 있다. 


## 안정 해시  

해시 테이블의 크기가 조정될 때 평균적으로 오직 k/n 개의 키만 재배치하는 해시 기술이다.  
여기서 k는 키의 개수이고, n은 슬롯의 개수다.

### 해시 공간과 해시 링 

- 해시 함수 f로 SHA-1을 사용한다고 하고,
  - 그 함수의 출력 값 범위는 x0, x1, ..., xN 이라고 하자. 
  - SHA-1의 출력 값은 0에서 2^160-1까지의 정수값을 가진다.
  - x0는 0, x1은 2^160-1까지의 정수값을 가진다.

### 해시 서버 

- 함수 f를 사용하면 서버 IP나 이름을 이 링 위의 어떤 위치에 대응시킬 수 있다. 

### 해시 키

- "해시 키 재배치 문제"에 언급된 함수와 다르며, "나머지 연산 %는 사용하지 않고 있음"에 정의하자.
